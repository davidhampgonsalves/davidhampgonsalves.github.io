<!doctype html><html lang=en-US><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content><link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel=stylesheet media=print type=text/css onload='this.media="all"'><title>Reverse Engineering Cat Genie 120 DRM</title><link rel=canonical href=https://davidhampgonsalves.com/reverse-engineering-cat-genie-120-drm/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;line-height:160%;color:#1d1313;max-width:700px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3{font-family:old standard tt,serif}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h2 a,h3 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#links{display:flex;justify-content:space-between;margin:50px 0 0}#links :nth-child(1){margin-right:.5em}#links :nth-child(2){margin-left:.5em}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}@media(prefers-color-scheme:dark){*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}}</style></head><body><section id=nav><h1><a href=https://davidhampgonsalves.com/>David Hamp-Gonsalves</a></h1><ul><li><a href=//github.com/davidhampgonsalves>GitHub</a></li><li><a href=https://instagram.com/davidhampgonsalves/>Instagram</a></li><li><a href=https://davidhampgonsalves.com/projects/>Projects</a></li></ul></section><section id=content><h1>Reverse Engineering Cat Genie 120 DRM</h1><div id=sub-header>July 2018 Â· 4 minute read</div><div class=entry-content><p><em><strong>TLDR</strong>: My robot cat litter box bricks itself after a set number of washes with each soap cartridge so I reverse engineered and suppressed the verfication process to enable refilling.</em></p><img src=//github.com/davidhampgonsalves/CR14-emulator-for-CatGenie-120/raw/master/catgenie.gif class=right-justify style=width:280px;margin-left:1em><h3 id=problem>Problem</h3><p>I bought a robot cat litter box called the CatGenie 120 and it was great&mldr; until I realized that the helpful low soap warning was actually DRM which blocks all cleaning actions once its official soap cartridge is &ldquo;empty&rdquo;.</p><p>I hadn&rsquo;t done anything like this previously but through listening to the <a href=//reverseengineering.libsyn.com/>Unnamed Reverse Engineering Podcast</a> over the previous few months I felt I knew enough about the tools and techniques required to get started.</p><h3 id=research>Research</h3><p>Looking at the cartridge I found an RFID tag under the label. Initially, still thinking the device bricking might be more oversight then malicious business strategy, I tried an unrelated RFID tag but it was rejected.</p><p>Online I found that someone named MindBender had already suppressed these limitations and was selling a closed source solution called the <a href=http://cartridgegenius.com/>CartridgeGenius</a>. They were out of stock at the time and I wasn&rsquo;t sure more were coming so pressed on. Knowing that MindBender was suppressing the DRM by replacing the RFID reader remedied a concern I had regarding the possibility of usage counts being stored on the main board in EEPROM.</p><p>Next I took the device apart and removed the RFID reader. Based on its markings and Googling I identified it as a CR14 made by <a href=//www.st.com/>ST</a> and found a copy of the <a href=https://github.com/davidhampgonsalves/CR14-emulator-for-CatGenie-120/raw/master/CR14-datasheet.pdf>datasheet</a>.</p><h3 id=probing>Probing</h3><p>From the datasheet I knew that the main device was communicating with the CR14 via I2C. I had learned about cheap logic analyzers and <a href=//sigrok.org/>Sigrok</a> from the podcast so I ordered one off of AliExpress for 5$ and waited. Once it arrived I ran into a series of issues. First the wires that connect to the chip used incorrect colors(I think to be misleading) and combined with this being my first time using a logic analizer it took me awhile to figure out. After that my lack of knowledge about I2C and signal analyzers sampling rates caught up to me and killed another few days of free time.</p><p>Eventually I got everything working and recorded my first accurate signal capture:</p><p><img src=https://davidhampgonsalves.com/images/cr14/sigrok-screenshot-1.png alt></p><h3 id=reverse-engineering>Reverse Engineering</h3><p>Things get a bit hand wavy here but based on what I was seeing in SIGROK and what I had read in the datasheet I mapped out the basic repeating sequence which comprised the tag validation process. If you are intersted take a look at the <a href=//github.com/davidhampgonsalves/CR14-emulator-for-CatGenie-120/raw/master/tag-validation.sr>sigrok captures</a> or read the commented <a href=//github.com/davidhampgonsalves/CR14-emulator-for-CatGenie-120/blob/master/src/main.cpp>source code</a> which documents how it works.</p><h3 id=arduino-based-cr14-emulator>Arduino Based CR14 Emulator</h3><p>After I had a rough idea of what the main board was expecting from the CR14 I wrote some code for an Arduino to emulate it. I ran into issues using Serial writes in the I2C response call backs, I think because they slowed the responses down but eventually I figured that out and switched to using the logic analyzer to debug what was happening. As I worked on this, sitting on the cold bathroom floor the CatGenie serinaded me with angry beeps every few seconds. Finally getting the tag validation working and stopping the beeping was a relief. If I knew how long I would be sitting there I would have located and disabled the beeper.</p><p>After the beeping stopped I realized that there was still more work to be done as the CatGenie wouldn&rsquo;t actually start. I captured <a href=//github.com/davidhampgonsalves/CR14-emulator-for-CatGenie-120/raw/master/write-remaining-count.sr>more samples</a> right as I pressed the start button and found the logic that decrements the usage count. Once I implemented that portion of the logic I was able to successfully run the device.</p><p><img src=https://davidhampgonsalves.com/images/cr14/sigrok-screenshot-2.png alt></p><h3 id=closing>Closing</h3><p>If you want to perform similar modifications as these check out the <a href=//github.com/davidhampgonsalves/CR14-emulator-for-CatGenie-120>git repo</a> and it will guide you through the process.</p><p>Another alternative is to run a opensource firmware also created by the author of the CartridgeGenius called <a href=https://github.com/CatGenius/catgenius/>CatGenius</a> but if you choose this route know that you can&rsquo;t revert back to the original firmware.</p><p><em>Press:</em> <a href=https://hackaday.com/2018/09/04/doing-logic-analysis-to-get-around-the-catgenies-drm/>Hackaday</a>, <a href="https://news.ycombinator.com/item?id=17858218">Hacker News</a> and the <a href=https://reverseengineering.libsyn.com/015-updates>Unnamed Reverse Engineering Podcast</a>.</p></div><div id=links><a href=https://davidhampgonsalves.com/arduino-grow-clock/>&#171;&nbsp;Arduino Grow Clock</a>
<a href=https://davidhampgonsalves.com/halloween-mask-2018/>Halloween Mask 2018&nbsp;&#187;</a></div></section></body></html>